<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Factory Game</title>
	<script type='text/javascript' src='./../miniGames/functions.js'></script>
	<style>
		body {
			margin: 0;
			background-repeat: no-repeat;
			overflow: hidden;
			background-size: 100vw;
			background-color: rgb(0, 0, 0);
			font-family: "Comic Sans MS";
			text-align: center;
		}

		p {
			margin: 0;
		}

		#grid {
			background-color: rgb(255, 255, 255);
			position: absolute;
			z-index: 0;
		}

		.center {
			left: 50%;
			transform: translateX(-50%);
		}
	</style>
</head>

<body>
	<canvas id='grid' class='center'></canvas>

	<script>
		//replace minigameName in script and title also add minigameName to functions.js like this
		// minigameName: {
		// 	score: 0
		// }
		var zoom = 1
		var gameData
		gameData = getData()
		if (gameData == null) {
			gameData = resetData()
			sendData(gameData)
		}

		setInterval(() => {
			if (gameData != null) {
				sendData(gameData)
			}
		}, 1);

		var canvas = document.getElementById('grid')
		var context = canvas.getContext('2d');
		context.canvas.width = window.innerWidth
		context.canvas.height = window.innerHeight
		var biggerSize = Math.max(canvas.clientWidth, canvas.clientHeight)
		var tileSize = 100 * zoom
		var rotation = 90
		var player = {
			x: 0,
			y: 0,
			speed: 10,
			hotbar: ['miner', 'conveyor', '', '', '', '', '', '', ''],
			inventory: [],
			selectedObject: '',
			radius: biggerSize * 0.02,
			color: 'red',
			draw: function () {
				context.beginPath();
				context.fillStyle = this.color
				context.arc(canvas.clientWidth / 2, canvas.clientHeight / 2, this.radius * zoom, 0, 2 * Math.PI);
				context.fill()
			},
			move: function () {
				let speed = this.speed
				if (keys.sprint) speed *= 3
				if (keys.up)
					this.y -= speed
				if (keys.down)
					this.y += speed
				if (keys.left)
					this.x -= speed
				if (keys.right)
					this.x += speed

			}
		}

		var objects = []
		class miner {
			constructor(x, y) {
				this.x = Math.round(x / tileSize) * tileSize
				this.y = Math.round(y / tileSize) * tileSize
				this.radius = biggerSize * 0.02
				this.color = 'green'
				this.inventory = []
			}
			draw() {
				context.beginPath();
				context.fillStyle = this.color
				context.arc(this.x - player.x + canvas.clientWidth / 2, this.y - player.y + canvas.clientHeight / 2, this.radius * zoom, 0, 2 * Math.PI);
				context.fill()
			}
		}
		class conveyor {
			constructor(x, y) {
				this.x = Math.round(x / tileSize) * tileSize - tileSize / 2
				this.y = Math.round(y / tileSize) * tileSize - tileSize / 2
				this.size = tileSize
				this.color = 'blue'
				this.inventory = []
				this.rotation = rotation
			}
			draw() {
				context.beginPath();
				context.fillStyle = this.color
				let img = new Image
				img.src = 'conveyor.png'
				img.style.rotate = rotation + 'deg'
				context.drawImage(img, this.x - player.x + canvas.clientWidth / 2, this.y - player.y + canvas.clientHeight / 2, this.size, this.size)
			}
		}

		var keys = {
			up: false,
			down: false,
			left: false,
			right: false,
			sprint: false
		}
		document.addEventListener('click', (event) => {
			let objectPos = [event.clientX - canvas.clientWidth / 2 + player.x, event.clientY - canvas.clientHeight / 2 + player.y]
			switch (player.selectedObject) {
				case 'miner':
					objects.push(new miner(objectPos[0], objectPos[1]))
					break;
				case 'conveyor':
					objects.push(new conveyor(objectPos[0], objectPos[1]))
					break;
			}
		})
		document.addEventListener('keydown', (event) => {
			if (event.keyCode == 87 || event.keyCode == 38)
				keys.up = true
			if (event.keyCode == 83 || event.keyCode == 40)
				keys.down = true
			if (event.keyCode == 65 || event.keyCode == 37)
				keys.left = true
			if (event.keyCode == 68 || event.keyCode == 39)
				keys.right = true
			if (event.keyCode == 16)
				keys.sprint = true
			if (event.keyCode == 49)
				player.selectedObject = player.hotbar[0]
			else if (event.keyCode == 50)
				player.selectedObject = player.hotbar[1]
			else if (event.keyCode == 51)
				player.selectedObject = player.hotbar[2]
			else if (event.keyCode == 52)
				player.selectedObject = player.hotbar[3]
			else if (event.keyCode == 53)
				player.selectedObject = player.hotbar[4]
			else if (event.keyCode == 54)
				player.selectedObject = player.hotbar[5]
			else if (event.keyCode == 55)
				player.selectedObject = player.hotbar[6]
			else if (event.keyCode == 56)
				player.selectedObject = player.hotbar[7]
			else if (event.keyCode == 57)
				player.selectedObject = player.hotbar[8]
		})
		document.addEventListener('keyup', (event) => {
			if (event.keyCode == 87 || event.keyCode == 38)
				keys.up = false
			if (event.keyCode == 83 || event.keyCode == 40)
				keys.down = false
			if (event.keyCode == 65 || event.keyCode == 37)
				keys.left = false
			if (event.keyCode == 68 || event.keyCode == 39)
				keys.right = false
			if (event.keyCode == 16)
				keys.sprint = false
		})

		document.addEventListener('wheel', (event) => {
			if (event.deltaY <= 100 && event.deltaY >= -100)
				zoom += event.deltaY * -0.001
			if (zoom < 0.5) zoom = 0.5
			if (zoom > 2.5) zoom = 2.5
		})

		function drawGrid(xPos, yPos, height, width) {
			context.lineWidth = 5
			context.strokeStyle = 'black'
			xPos -= player.x + tileSize / 2
			yPos -= player.y + tileSize / 2
			for (let x = xPos;x > 0;x -= tileSize) {
				context.moveTo(x, 0)
				context.lineTo(x, height)
				context.stroke()
			}
			for (let x = xPos;x < width;x += tileSize) {
				context.moveTo(x, 0)
				context.lineTo(x, height)
				context.stroke()
			}
			for (let y = yPos;y > 0;y -= tileSize) {
				context.moveTo(0, y)
				context.lineTo(width, y)
				context.stroke()
			}
			for (let y = yPos;y < height;y += tileSize) {
				context.moveTo(0, y)
				context.lineTo(width, y)
				context.stroke()
			}
		}

		setInterval(() => {
			context.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight)
			drawGrid(canvas.clientWidth / 2, canvas.clientHeight / 2, canvas.clientHeight, canvas.clientWidth);
			for (object of objects) {
				object.draw()
			}
			player.draw()
			player.move()
		}, 1);
	</script>
</body>

</html>