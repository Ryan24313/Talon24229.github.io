<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fun With Plushtrap</title>
	<script type='text/javascript' src='../functions.js'></script>
	<style>
		body {
			margin: 0;
			background-repeat: no-repeat;
			overflow: hidden;
			background-size: 100vw;
			background-color: rgb(0, 0, 0);
			font-family: "Comic Sans MS";
			text-align: center;
		}

		p {
			margin: 0;
		}

		#cabinet {
			position: absolute;
			height: 140%;
			z-index: 6;
			top: -25%;
			pointer-events: none;
		}

		#background {
			position: absolute;
			top: 24%;
			height: 52%;
			width: 50%;
			z-index: 1;
		}

		#bbackground {
			position: absolute;
			top: 24%;
			height: 52%;
			width: 50%;
			z-index: 0;
		}

		.center {
			left: 50%;
			transform: translateX(-50%);
			position: absolute;
		}

		#button {
			position: absolute;
			top: 82.5vh;
			height: 7vh;
			width: 7vw;
			left: 49.5%;
			z-index: 1000;
			cursor: pointer;
		}

		#timer {
			z-index: 3;
			color: rgb(94, 94, 94);
			top: 24%;
			font-size: 5vh;
			text-align: left;
			left: 70%;
			text-shadow: 2px 0 rgb(0, 0, 0), -2px 0 rgb(0, 0, 0), 0 2px rgb(0, 0, 0), 0 -2px rgb(0, 0, 0),
				1px 1px rgb(0, 0, 0), -1px -1px rgb(0, 0, 0), 1px -1px rgb(0, 0, 0), -1px 1px rgb(0, 0, 0);
		}
	</style>
</head>

<body>
	<img id='cabinet' class='center' src=" ../cabinet.png">
	<img id='background' class='center'>
	<div id='button' class='center'></div>
	<img id='bbackground' class='center' src="empty.png">
	<p class="center" id='timer'></p>

	<script>
		//min time 1 second max time 10 seconds

		//Plushtrap is 45 second sessions
		//BB Extras is 60 seconds.

		// -There are sound cues for each position he advances to. 
		//First, there will be small, quiet footsteps, meaning he got up from the chair, 
		//but didn't advance yet. 
		//Then there will be a scurry sound, meaning he advanced to the first set of doors. 
		//Then there will be the small footsteps again, 
		//meaning he came out of the door and is in the middle of the hallway. 
		//Another scurry after that means he advanced to the second set of doors. 
		//One more small footsteps sound after the second scurry and he is on the X. 
		//If you hear a third scurry, that means he will jumpscare you if you flash your light.

		// -The above means you can win every time, 
		//RNG permitting (it's random when he moves). Listen for 2 scurries. 
		//After that, as soon as you hear small, quiet footsteps, flash your light. You win!

		// Other than that, there isn't really much to know, unfortunately. 
		//We are still in the midst of getting a decompiled game without corrupt 
		//events and textures, so we can't see EXACTLY what's going on yet. 
		//We can only vaguely estimate.

		//noise gets louder as it increases in stage
		//plushtrap 
		var timerElement = document.getElementById("timer")
		var displayState = document.getElementById("background")
		var bback = document.getElementById("bbackground")
		var stage = 1
		displayState.src = `Off.png`
		var time = { minutes: 0, seconds: 45 }
		var rand
		var light = false
		var killed = false
		var ambiance= new Audio('ambiancealt.mp3');
		var reload = false
		var seen = false
		var skurry = new Audio('skurry.mp3');
		var started = false
		changed = false
		var side
		var tapped = false
		var deathSpeed = []
		let userAgent = navigator.userAgent;
		if (userAgent.match(/firefox|fxios/i)) {
			deathSpeed = [.9, 1.5]
		}
		else {
			deathSpeed = [.3, .5]
		}      
		
		
		//speed
		// var speed = Math.round(Math.random() * 10000) + 3000
		// setInterval(() => {
		// 	speed = Math.round(Math.random() * 10000) + 3000
		// }, 10);
		var speed = 2000

			//light logic
		document.addEventListener('keydown', (event) => {
			if (!killed && event.keyCode == 32) {
				light = true
				if(!changed){
					changed = true
					let light = new Audio('FlashlightFNAF4.ogg');
					light.play()
					}
				}
				if (!tapped) {
					tapped=true
					setInterval(() => {
				ambiance.play()
				}, ambiance.duration*1000);
				}
			})
			document.addEventListener('keyup', (event) => {
				if (!killed && event.keyCode == 32) {          
					light = false
					if(changed){
						changed = false
						let light = new Audio('FlashlightFNAF4.ogg');
						light.play()
					}
				}
			})

		setInterval(() => {
			//movement, while there is no light
			if (!light && stage < 7 && !killed) {
				stage += 1
				seen = false
				rand = Math.round(Math.random())
				if (rand == 0)
					side = "L"
				else {
					side = "R"
				}
				volume = '0.'+ stage
				volume = parseFloat(volume)
				console.log(seen);
				skurry.volume = volume
				skurry.play()
			}
		}, speed);

		setInterval(() => {  
			//if there is a light on, and not dead
			if (light && stage < 7 && !killed) {
				skurry.pause()
				if (stage == 1) {
					displayState.src = `${stage}.png`
				}
				 
				else if (stage == 2) {
					if(!seen){
						if(!started){
							displayState.src = `2.gif`
							started = true
						}
						else if (started) {
							setTimeout(() => {
								stage = 1
								displayState.src = `${stage}.png`
								seen = true
								started = false
							}, 300);				
						}
					}
					else if (seen){
						displayState.src = `${stage}.png`
					}
				}
				// doors
				else if ((stage == 3 || stage == 5)) {
					if(!seen){
						if(!started){
							displayState.src = `${stage + side}.gif`
							started = true
						}
						else if (started) {
							setTimeout(() => {
								displayState.src = ``
								seen = true
								started = false
							}, 1700);				
						}
					}
					else if (seen){
						displayState.src = ``
					}
				}
				//sitting in hall
				else if ((stage == 4 || stage == 6)) {
					if(!seen){
						if(!started){
							displayState.src = `${stage}.gif`
							started = true
						}
						else if (started) {
							setTimeout(() => {
								displayState.src = `${stage}.png`
								seen = true
								started = false
							}, 490);				
						}
					}
					else if (seen){
						displayState.src = `${stage}.png`
					}
				}

			}      
			//kill
			else if (stage == 7 && !killed) {
				killed = true
				if (side == "R") {
					let scream = new Audio('scream.mp3');
					scream.play()
					displayState.src = `${stage}.gif`
				}
				else {
					displayState.src = `${stage}alt.gif`
				}
				let scream = new Audio('scream.mp3');
				scream.play()
				setTimeout(() => {
					let bright = 250
					let bbright = 100
					displayState.src = `tooBadText.png`
					displayState.style.filter = `brightness(${bright}%)`
					bback.style.filter = `brightness(${bright}%)`
					bback.src = `tooBad.png`
					setInterval(() => {
						bright -= deathSpeed[0]
						bback.style.filter = `brightness(${bright}%)`
						if (bright <= 20) {
							bbright -= deathSpeed[1]
							displayState.style.filter = `brightness(${bbright}%)`
							if (bbright <= 0) {
								if (!reload) {
									reload = true
									location.reload();
								}
							}
						}
					}, 1);
				}, 1800)
			}
			//light controller
			else if (!killed) {
				displayState.src = 'Off.png'
			}       
		}, 1);

		//Cabinet button
		var button = document.getElementById('button')
		button.addEventListener('click', () => {
			cabinet.src = '../cabinetRed.png'
			setTimeout(() => {
				cabinet.src = '../cabinet.png'
				window.location.pathname = '/miniGames/index.html'
			}, 300)
		})
		//timer
		timer = setInterval(() => {
			if (!killed) {
				if (time.seconds > 0 || time.minutes > 0)
				if (time.seconds > 0)
				time.seconds -= 1
					else {
						time.minutes -= 1
						time.seconds = 59
					}
					if (time.seconds < 10) {
						timerElement.innerText = '0' + time.seconds
				}
				else {
					timerElement.innerText = time.seconds
				}
				//timed Out
				if (time.minutes <= 0 && time.seconds == 0 && !killed) {
					killed = true
					let bright = 250
					let bbright = 100
					displayState.src = `tooBadText.png`
					displayState.style.filter = `brightness(${bright}%)`

					bback.style.filter = `brightness(${bright}%)`
					bback.src = `tooBad.png`

					setInterval(() => {
						bright -= deathSpeed[0]
						bback.style.filter = `brightness(${bright}%)`
						if (bright <= 20) {
							bbright -= deathSpeed[1]
							displayState.style.filter = `brightness(${bbright}%)`
							if (bbright <= 0) {
								if (!reload) {
									reload = true
									location.reload();
								}
							}
						}
					}, 1);
                }
			}
			else {
				timerElement.innerText = ""
			}
		}, 1000);
		
		// var score = 0
		// var gameData
		// gameData = getData()
		// if (gameData == null) {
		// 	gameData = resetData()
		// 	sendData(gameData)
		// }
		
		// setInterval(() => {
		// 	if (gameData != null && score > gameData.PlushTrap.highScore) {
			// 		gameData.PlushTrap.highScore = score
			// 		sendData(gameData)
			// 	}
			// }, 1)
			</script>
</body>

</html>